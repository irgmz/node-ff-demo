const t={staleTTL:6e4,cacheKey:"gbFeaturesCache",backgroundSync:!0},e={fetch:globalThis.fetch?globalThis.fetch.bind(globalThis):void 0,SubtleCrypto:globalThis.crypto?globalThis.crypto.subtle:void 0,EventSource:globalThis.EventSource};try{globalThis.localStorage&&(e.localStorage=globalThis.localStorage)}catch(t){}const n=new Map;let r=!1;const i=new Map,s=new Map,o=new Map,u=new Set;function h(t){Object.assign(e,t)}function c(e){Object.assign(t,e),t.backgroundSync||v()}async function a(){i.clear(),s.clear(),v(),r=!1,await f()}async function f(){try{if(!e.localStorage)return;await e.localStorage.setItem(t.cacheKey,JSON.stringify(Array.from(i.entries())))}catch(t){}}function l(t){const[e,n]=t.getApiInfo();return["".concat(e,"||").concat(n),e,n]}function d(e,r){const s=r.dateUpdated||"",o=new Date(Date.now()+t.staleTTL),u=i.get(e);if(u&&s&&u.version===s)return void(u.staleAt=o);i.set(e,{data:r,version:s,staleAt:o}),f();const h=n.get(e);h&&h.forEach((t=>w(t,r)))}async function w(t,n){await(n.encryptedFeatures?t.setEncryptedFeatures(n.encryptedFeatures,void 0,e.SubtleCrypto):t.setFeatures(n.features||t.getFeatures()))}async function y(t){const[n,r,i]=l(t),o=r+"/api/features/"+i;let h=s.get(n);return h||(h=e.fetch(o).then((t=>("enabled"===t.headers.get("x-sse-support")&&u.add(n),t.json()))).then((e=>(d(n,e),p(t),s.delete(n),e))).catch((t=>(s.delete(n),Promise.resolve({})))),s.set(n,h)),await h}function p(n){const[r,i,s]=l(n);if(t.backgroundSync&&u.has(r)&&e.EventSource){if(o.has(r))return;const t={src:new e.EventSource("".concat(i,"/sub/").concat(s)),cb:e=>{try{const n=JSON.parse(e.data);d(r,n),t.errors=0}catch(e){b(t,r)}},errors:0};o.set(r,t),t.src.addEventListener("features",t.cb),t.src.onerror=()=>{b(t,r)}}}function b(t,e){t.errors++,(t.errors>3||2===t.src.readyState)&&g(t,e)}function g(t,e){t.src.onerror=null,t.src.close(),o.delete(e)}function v(){u.clear(),o.forEach(g),n.clear()}function $(t){let e=2166136261;const n=t.length;for(let r=0;r<n;r++)e^=t.charCodeAt(r),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e>>>0}function A(t,e,n){return 2===n?$($(t+e)+"")%1e4/1e4:1===n?$(e+t)%1e3/1e3:-1}function m(t,e){return t>=e[0]&&t<e[1]}const O={};function S(t,e){if("$or"in e)return x(t,e.$or);if("$nor"in e)return!x(t,e.$nor);if("$and"in e)return function(t,e){for(let n=0;n<e.length;n++)if(!S(t,e[n]))return!1;return!0}(t,e.$and);if("$not"in e)return!S(t,e.$not);for(const[n,r]of Object.entries(e))if(!F(r,_(t,n)))return!1;return!0}function _(t,e){const n=e.split(".");let r=t;for(let t=0;t<n.length;t++){if(!r||"object"!=typeof r||!(n[t]in r))return null;r=r[n[t]]}return r}function F(t,e){if("string"==typeof t)return e+""===t;if("number"==typeof t)return 1*e===t;if("boolean"==typeof t)return!!e===t;if(Array.isArray(t)||!T(t))return JSON.stringify(e)===JSON.stringify(t);for(const n in t)if(!k(n,e,t[n]))return!1;return!0}function T(t){const e=Object.keys(t);return e.length>0&&e.filter((t=>"$"===t[0])).length===e.length}function k(t,e,n){switch(t){case"$eq":return e===n;case"$ne":return e!==n;case"$lt":return e<n;case"$lte":return e<=n;case"$gt":return e>n;case"$gte":return e>=n;case"$exists":return n?null!==e:null===e;case"$in":return n.includes(e);case"$nin":return!n.includes(e);case"$not":return!F(n,e);case"$size":return!!Array.isArray(e)&&F(n,e.length);case"$elemMatch":return function(t,e){if(!Array.isArray(t))return!1;const n=T(e)?t=>F(e,t):t=>S(t,e);for(let e=0;e<t.length;e++)if(t[e]&&n(t[e]))return!0;return!1}(e,n);case"$all":if(!Array.isArray(e))return!1;for(let t=0;t<n.length;t++){let r=!1;for(let i=0;i<e.length;i++)if(F(n[t],e[i])){r=!0;break}if(!r)return!1}return!0;case"$regex":try{return(r=n,O[r]||(O[r]=new RegExp(r.replace(/([^\\])\//g,"$1\\/"))),O[r]).test(e)}catch(t){return!1}case"$type":return function(t){if(null===t)return"null";if(Array.isArray(t))return"array";const e=typeof t;return["string","number","boolean","object","undefined"].includes(e)?e:"unknown"}(e)===n;default:return console.error("Unknown operator: "+t),!1}var r}function x(t,e){if(!e.length)return!0;for(let n=0;n<e.length;n++)if(S(t,e[n]))return!0;return!1}const E="undefined"!=typeof window&&"undefined"!=typeof document,V=t=>Uint8Array.from(atob(t),(t=>t.charCodeAt(0)));class C{constructor(t){this.t=this.context=t=t||{},this.i=null,this.o=new Set,this.u={},this.debug=!1,this.h=new Set,this.l=[],this.p=0,this.ready=!1,this.g=new Map,this.v=new Map,this.$={},t.features&&(this.ready=!0),E&&t.enableDevMode&&(window._growthbook=this,document.dispatchEvent(new Event("gbloaded"))),t.clientKey&&this.A({},!0,!1)}async loadFeatures(t){await this.A(t,!0,!0),t&&t.autoRefresh&&function(t){const[e]=l(t),r=n.get(e)||new Set;r.add(t),n.set(e,r)}(this)}async refreshFeatures(t){await this.A(t,!1,!0)}getApiInfo(){return[(this.t.apiHost||"https://cdn.growthbook.io").replace(/\/*$/,""),this.t.clientKey||""]}async A(n,s,o){if(n=n||{},!this.t.clientKey)throw new Error("Missing clientKey");await async function(n,s,o,u,h){const c=await async function(n,s,o,u){const[h]=l(n),c=new Date;await async function(){if(!r){r=!0;try{if(e.localStorage){const n=await e.localStorage.getItem(t.cacheKey);if(n){const t=JSON.parse(n);t&&Array.isArray(t)&&t.forEach((t=>{let[e,n]=t;i.set(e,{...n,staleAt:new Date(n.staleAt)})}))}}}catch(t){}}}();const a=i.get(h);if(a&&!u&&(s||a.staleAt>c))return a.staleAt<c?y(n):p(n),a.data;{const t=await function(t,e){return new Promise((n=>{let r,i=!1;const s=t=>{i||(i=!0,r&&clearTimeout(r),n(t||null))};e&&(r=setTimeout((()=>s()),e)),t.then((t=>s(t))).catch((()=>s()))}))}(y(n),o);return t}}(n,u,s,o);h&&c&&await w(n,c)}(this,n.timeout,n.skipCache||this.t.enableDevMode,s,o)}m(){this.i&&this.i()}setFeatures(t){this.t.features=t,this.ready=!0,this.m()}async setEncryptedFeatures(t,e,n){if(e=e||this.t.decryptionKey||"",!(n=n||globalThis.crypto&&globalThis.crypto.subtle))throw new Error("No SubtleCrypto implementation found");try{const r=await n.importKey("raw",V(e),{name:"AES-CBC",length:128},!0,["encrypt","decrypt"]),[i,s]=t.split("."),o=await n.decrypt({name:"AES-CBC",iv:V(i)},r,V(s));this.setFeatures(JSON.parse((new TextDecoder).decode(o)))}catch(t){throw new Error("Failed to decrypt features")}}setAttributes(t){this.t.attributes=t,this.m()}setAttributeOverrides(t){this.$=t,this.m()}setForcedVariations(t){this.t.forcedVariations=t||{},this.m()}setForcedFeatures(t){this.v=t,this.m()}getAttributes(){return{...this.t.attributes,...this.$}}getFeatures(){return this.t.features||{}}subscribe(t){return this.h.add(t),()=>{this.h.delete(t)}}getAllResults(){return new Map(this.g)}destroy(){var t;this.h.clear(),this.g.clear(),this.o.clear(),this.u={},this.l=[],this.p&&clearTimeout(this.p),t=this,n.forEach((e=>e.delete(t))),E&&window._growthbook===this&&delete window._growthbook}setRenderer(t){this.i=t}forceVariation(t,e){this.t.forcedVariations=this.t.forcedVariations||{},this.t.forcedVariations[t]=e,this.m()}run(t){const e=this.O(t,null);return this.S(t,e),e}S(t,e){const n=t.key,r=this.g.get(n);r&&r.result.inExperiment===e.inExperiment&&r.result.variationId===e.variationId||(this.g.set(n,{experiment:t,result:e}),this.h.forEach((n=>{try{n(t,e)}catch(t){console.error(t)}})))}_(t,e){if("override"===e.source)return;const n=JSON.stringify(e.value);if(this.u[t]!==n){if(this.u[t]=n,this.t.onFeatureUsage)try{this.t.onFeatureUsage(t,e)}catch(t){}E&&window.fetch&&(this.l.push({key:t,on:e.on}),this.p||(this.p=window.setTimeout((()=>{this.p=0;const t=[...this.l];this.l=[],this.t.realtimeKey&&window.fetch("https://rt.growthbook.io/?key=".concat(this.t.realtimeKey,"&events=").concat(encodeURIComponent(JSON.stringify(t))),{cache:"no-cache",mode:"no-cors"}).catch((()=>{}))}),this.t.realtimeInterval||2e3)))}}F(t,e,n,r,i,s){const o={value:e,on:!!e,off:!e,source:n,ruleId:r||""};return i&&(o.experiment=i),s&&(o.experimentResult=s),this._(t,o),o}isOn(t){return this.evalFeature(t).on}isOff(t){return this.evalFeature(t).off}getFeatureValue(t,e){const n=this.evalFeature(t).value;return null===n?e:n}feature(t){return this.evalFeature(t)}evalFeature(t){if(this.v.has(t))return this.F(t,this.v.get(t),"override");if(!this.t.features||!this.t.features[t])return this.F(t,null,"unknownFeature");const e=this.t.features[t];if(e.rules)for(const n of e.rules){if(n.condition&&!this.T(n.condition))continue;if(n.filters&&this.k(n.filters))continue;if("force"in n){if(!this.V(n.seed||t,n.hashAttribute,n.range,n.coverage,n.hashVersion))continue;return n.tracks&&n.tracks.forEach((t=>{this.C(t.experiment,t.result)})),this.F(t,n.force,"force",n.id)}if(!n.variations)continue;const e={variations:n.variations,key:n.key||t};"coverage"in n&&(e.coverage=n.coverage),n.weights&&(e.weights=n.weights),n.hashAttribute&&(e.hashAttribute=n.hashAttribute),n.namespace&&(e.namespace=n.namespace),n.meta&&(e.meta=n.meta),n.ranges&&(e.ranges=n.ranges),n.name&&(e.name=n.name),n.phase&&(e.phase=n.phase),n.seed&&(e.seed=n.seed),n.hashVersion&&(e.hashVersion=n.hashVersion),n.filters&&(e.filters=n.filters);const r=this.O(e,t);if(this.S(e,r),r.inExperiment&&!r.passthrough)return this.F(t,r.value,"experiment",n.id,e,r)}return this.F(t,void 0===e.defaultValue?null:e.defaultValue,"defaultValue")}V(t,e,n,r,i){if(!n&&void 0===r)return!0;const{hashValue:s}=this.I(e);if(!s)return!1;const o=A(t,s,i||1);return n?m(o,n):void 0===r||o<=r}T(t){return S(this.getAttributes(),t)}k(t){return t.some((t=>{const{hashValue:e}=this.I(t.attribute);if(!e)return!0;const n=A(t.seed,e,t.hashVersion||2);return!t.ranges.some((t=>m(n,t)))}))}O(t,e){const n=t.key,r=t.variations.length;if(r<2)return this.M(t,-1,!1,e);if(!1===this.t.enabled)return this.M(t,-1,!1,e);t=this.N(t);const i=function(t,e,n){if(!e)return null;const r=e.split("?")[1];if(!r)return null;const i=r.replace(/#.*/,"").split("&").map((t=>t.split("=",2))).filter((e=>{let[n]=e;return n===t})).map((t=>{let[,e]=t;return parseInt(e)}));return i.length>0&&i[0]>=0&&i[0]<n?i[0]:null}(n,this.J(),r);if(null!==i)return this.M(t,i,!1,e);if(this.t.forcedVariations&&n in this.t.forcedVariations)return this.M(t,this.t.forcedVariations[n],!1,e);if("draft"===t.status||!1===t.active)return this.M(t,-1,!1,e);const{hashValue:s}=this.I(t.hashAttribute);if(!s)return this.M(t,-1,!1,e);if(t.filters){if(this.k(t.filters))return this.M(t,-1,!1,e)}else if(t.namespace&&!function(t,e){const n=A("__"+e[0],t,1);return n>=e[1]&&n<e[2]}(s,t.namespace))return this.M(t,-1,!1,e);if(t.include&&!function(t){try{return t()}catch(t){return console.error(t),!1}}(t.include))return this.M(t,-1,!1,e);if(t.condition&&!this.T(t.condition))return this.M(t,-1,!1,e);if(t.groups&&!this.R(t.groups))return this.M(t,-1,!1,e);if(t.url&&!this.j(t.url))return this.M(t,-1,!1,e);const o=A(t.seed||n,s,t.hashVersion||1),u=function(t,e){for(let n=0;n<e.length;n++)if(m(t,e[n]))return n;return-1}(o,t.ranges||function(t,e,n){(e=void 0===e?1:e)<0?e=0:e>1&&(e=1);const r=(i=t)<=0?[]:new Array(i).fill(1/i);var i;(n=n||r).length!==t&&(n=r);const s=n.reduce(((t,e)=>e+t),0);(s<.99||s>1.01)&&(n=r);let o=0;return n.map((t=>{const n=o;return o+=t,[n,n+e*t]}))}(r,void 0===t.coverage?1:t.coverage,t.weights));if(u<0)return this.M(t,-1,!1,e);if("force"in t)return this.M(t,void 0===t.force?-1:t.force,!1,e);if(this.t.qaMode)return this.M(t,-1,!1,e);if("stopped"===t.status)return this.M(t,-1,!1,e);const h=this.M(t,u,!0,e,o);return this.C(t,h),h}log(t,e){this.debug&&(this.t.log?this.t.log(t,e):console.log(t,e))}C(t,e){if(!this.t.trackingCallback)return;const n=e.hashAttribute+e.hashValue+t.key+e.variationId;if(!this.o.has(n)){this.o.add(n);try{this.t.trackingCallback(t,e)}catch(t){console.error(t)}}}N(t){const e=t.key,n=this.t.overrides;return n&&n[e]&&"string"==typeof(t=Object.assign({},t,n[e])).url&&(t.url=function(t){try{const e=t.replace(/([^\\])\//g,"$1\\/");return new RegExp(e)}catch(t){return void console.error(t)}}(t.url)),t}I(t){const e=t||"id";let n="";return this.$[e]?n=this.$[e]:this.t.attributes?n=this.t.attributes[e]||"":this.t.user&&(n=this.t.user[e]||""),{hashAttribute:e,hashValue:n}}M(t,e,n,r,i){let s=!0;(e<0||e>=t.variations.length)&&(e=0,s=!1);const{hashAttribute:o,hashValue:u}=this.I(t.hashAttribute),h=t.meta?t.meta[e]:{},c={key:h.key||""+e,featureId:r,inExperiment:s,hashUsed:n,variationId:e,value:t.variations[e],hashAttribute:o,hashValue:u};return h.name&&(c.name=h.name),void 0!==i&&(c.bucket=i),h.passthrough&&(c.passthrough=h.passthrough),c}J(){return this.t.url||(E?window.location.href:"")}j(t){const e=this.J();if(!e)return!1;const n=e.replace(/^https?:\/\//,"").replace(/^[^/]*\//,"/");return!!t.test(e)||!!t.test(n)}R(t){const e=this.t.groups||{};for(let n=0;n<t.length;n++)if(e[t[n]])return!0;return!1}}export{C as GrowthBook,a as clearCache,c as configureCache,h as setPolyfills};
//# sourceMappingURL=esm.min.js.map
